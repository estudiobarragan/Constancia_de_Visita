<!DOCTYPE html>
<html lang="es">
<head>
ย ย <meta charset="UTF-8">
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">
ย ย <title>Formulario de Reportes de Visita</title>
ย ย <style>
ย ย ย ย /* Estilos CSS que dan el formato estรฉtico */
ย ย ย ย body {
ย ย ย ย ย ย font-family: Arial, sans-serif;
ย ย ย ย ย ย margin: 20px;
ย ย ย ย ย ย background-color: #f4f4f9; /* Fondo gris claro */
ย ย ย ย ย ย color: #333;
ย ย ย ย }
ย ย ย ย .container {
ย ย ย ย ย ย max-width: 900px;
ย ย ย ย ย ย margin: auto;
ย ย ย ย ย ย background: #fff; /* Recuadro blanco */
ย ย ย ย ย ย padding: 30px;
ย ย ย ย ย ย border-radius: 8px;
ย ย ย ย ย ย box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
ย ย ย ย }
ย ย ย ย h1 {
ย ย ย ย ย ย color: #007bff;
ย ย ย ย ย ย border-bottom: 2px solid #007bff;
ย ย ย ย ย ย padding-bottom: 10px;
ย ย ย ย ย ย margin-bottom: 20px;
ย ย ย ย }
ย ย ย ย label {
ย ย ย ย ย ย display: block;
ย ย ย ย ย ย margin-top: 15px;
ย ย ย ย ย ย font-weight: bold;
ย ย ย ย }
ย ย ย ย input[type="text"], input[type="date"], select, textarea {
ย ย ย ย ย ย width: 100%;
ย ย ย ย ย ย padding: 10px;
ย ย ย ย ย ย margin-top: 5px;
ย ย ย ย ย ย border: 1px solid #ccc;
ย ย ย ย ย ย border-radius: 4px;
ย ย ย ย ย ย box-sizing: border-box;
ย ย ย ย }
ย ย ย ย textarea {
ย ย ย ย ย ย resize: vertical;
ย ย ย ย }
ย ย ย ย .actividades-grid {
ย ย ย ย ย ย display: grid;
ย ย ย ย ย ย grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
ย ย ย ย ย ย gap: 10px;
ย ย ย ย ย ย margin-top: 10px;
ย ย ย ย ย ย padding: 10px;
ย ย ย ย ย ย border: 1px solid #ddd;
ย ย ย ย ย ย border-radius: 4px;
ย ย ย ย }
ย ย ย ย .actividad-item {
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย align-items: center;
ย ย ย ย }
ย ย ย ย .actividad-item input[type="checkbox"] {
ย ย ย ย ย ย width: auto;
ย ย ย ย ย ย margin-right: 8px;
ย ย ย ย }
ย ย ย ย button {
ย ย ย ย ย ย background-color: #28a745;
ย ย ย ย ย ย color: white;
ย ย ย ย ย ย padding: 12px 20px;
ย ย ย ย ย ย border: none;
ย ย ย ย ย ย border-radius: 4px;
ย ย ย ย ย ย cursor: pointer;
ย ย ย ย ย ย font-size: 16px;
ย ย ย ย ย ย margin-top: 20px;
ย ย ย ย }
ย ย ย ย button:hover {
ย ย ย ย ย ย background-color: #218838;
ย ย ย ย }
ย ย ย ย .status-message {
ย ย ย ย ย ย margin-top: 20px;
ย ย ย ย ย ย padding: 10px;
ย ย ย ย ย ย border-radius: 4px;
ย ย ย ย ย ย font-weight: bold;
ย ย ย ย }
ย ย ย ย .status-success {
ย ย ย ย ย ย background-color: #d4edda;
ย ย ย ย ย ย color: #155724;
ย ย ย ย }
ย ย ย ย .status-error {
ย ย ย ย ย ย background-color: #f8d7da;
ย ย ย ย ย ย color: #721c24;
ย ย ย ย }
ย ย </style>
</head>
<body>

<div class="container">
ย ย <h1>๐ Reporte de Visitas</h1>
ย ย <form id="reporteForm">
ย ย ย ยย
ย ย ย ย <div>
ย ย ย ย ย ย <label for="fechaVisita">Fecha de Visita:</label>
ย ย ย ย ย ย <input type="date" id="fechaVisita" required>
ย ย ย ย </div>

ย ย ย ย <div>
ย ย ย ย ย ย <label for="idProfesional">ID Profesional:</label>
ย ย ย ย ย ย <input type="text" id="idProfesional" required>
ย ย ย ย </div>

        <div>
            <label for="idCliente">Cliente:</label>
            <select id="idCliente" required>
                <option value="" disabled selected>Cargando clientes...</option>
            </select>
        </div>

        <div>
            <label for="idEstablecimiento">Establecimiento:</label>
            <select id="idEstablecimiento" required disabled>
                <option value="" disabled selected>Seleccione primero un cliente...</option>
            </select>
        </div>
ย ย ย ยย
ย ย ย ย <label>Actividades Realizadas:</label>
ย ย ย ย <div id="actividadesContainer" class="actividades-grid">
ย ย ย ย ย ย <p>Cargando actividades...</p>
ย ย ย ย </div>

ย ย ย ย <div>
ย ย ย ย ย ย <label for="otrasTareas">Otras tareas realizadas:</label>
ย ย ย ย ย ย <textarea id="otrasTareas" rows="3"></textarea>
ย ย ย ย </div>

ย ย ย ย <div>
ย ย ย ย ย ย <label for="observaciones">Observaciones y recomendaciones realizadas:</label>
ย ย ย ย ย ย <textarea id="observaciones" rows="5"></textarea>
ย ย ย ย </div>

ย ย ย ย <button type="submit">Guardar Reporte</button>

ย ย ย ย <div id="statusMessage" class="status-message" style="display: none;"></div>
ย ย ย ยย
ย ย </form>
</div>

<script>
ย ย // โ๏ธ CONFIGURACIรN: REEMPLAZA ESTA URL CON LA TUYA
ย ย const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw6noiXFiMbctGbB99rW_1dlMsK7-0vMwUDRHUgvhzL3bWipdLz5-YkeluvoznpSGok/exec';ย
ย ย const form = document.getElementById('reporteForm');
ย ย const statusMessage = document.getElementById('statusMessage');
ย ย let CLIENTE_CARPETA_ID = null;
    let ESTABLECIMIENTOS_DATA = [];

ย ย // --- FUNCIONES DE UTILIDAD ---
ย ย function showStatus(message, isSuccess) {
ย ย ย ย statusMessage.textContent = message;
ย ย ย ย statusMessage.style.display = 'block';
ย ย ย ย statusMessage.className = 'status-message ' + (isSuccess ? 'status-success' : 'status-error');
ย ย }

ย ย async function fetchData(actionUrl) {
ย ย ย ย try {
            const separator = actionUrl.includes('&') ? '' : '?action=';
ย ย ย ย ย ย const url = `${WEB_APP_URL}${separator}${actionUrl}`;ย
ย ย ย ย ย ยย
ย ย ย ย ย ย const response = await fetch(url);
ย ย ย ย ย ยย
ย ย ย ย ย ย if (!response.ok) {
ย ย ย ย ย ย ย ย throw new Error(`HTTP error! status: ${response.status}`);
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย const data = await response.json();ย
ย ย ย ย ย ยย
ย ย ย ย ย ย return data;ย
ย ย ย ย ย ยย
ย ย ย ย } catch (error) {
ย ย ย ย ย ย console.error(`[CLIENTE] Error en fetchData para acciรณn ${actionUrl}:`, error);
ย ย ย ย ย ย return { success: false, message: 'Error de red o servidor: ' + error.message };
ย ย ย ย }
ย ย }

    // --- FUNCIONES DE CARGA (GET) ---
    
    async function cargarClientes() {
        const selector = document.getElementById('idCliente');
        selector.innerHTML = '<option value="" disabled selected>Cargando clientes...</option>'; 

        const result = await fetchData('getClientes'); 
        selector.innerHTML = ''; 
        
        if (result.success && result.data && result.data.length > 0) {
            selector.appendChild(new Option('Seleccione un cliente...', '', '', true));
            
            result.data.forEach(cliente => {
                const option = new Option(cliente.Nombre_Empresa, cliente.ID_Cliente);
                selector.appendChild(option);
            });

            selector.onchange = (event) => {
                const selectedId = event.target.value;
                cargarEstablecimientos(selectedId); 
            };
            
        } else {
            selector.innerHTML = '<option value="" disabled selected>No se encontraron clientes.</option>';
        }
    }

    async function cargarEstablecimientos(ID_Cliente_Filtro = null) {
        const selector = document.getElementById('idEstablecimiento');
        selector.innerHTML = ''; 
        selector.disabled = true;
        CLIENTE_CARPETA_ID = null; 

        if (!ID_Cliente_Filtro) {
            selector.innerHTML = '<option value="" disabled selected>Seleccione primero un cliente...</option>';
            return;
        }

        selector.innerHTML = '<option value="" disabled selected>Cargando establecimientos...</option>';
        
        const actionUrl = `getEstablecimientos&ID_Cliente=${ID_Cliente_Filtro}`;

        const result = await fetchData(actionUrl); 

        selector.innerHTML = ''; 

        if (result.success && result.data && result.data.length > 0) {
            
            ESTABLECIMIENTOS_DATA = result.data; 
            
            selector.appendChild(new Option('Seleccione un establecimiento...', '', '', true));
            
            ESTABLECIMIENTOS_DATA.forEach(est => {
                const option = new Option(`${est.Denominacion} (${est.Direccion})`, est.ID_Establecimiento);
                selector.appendChild(option);
            });
            
            selector.disabled = false;

            selector.onchange = (event) => {
                const selectedId = event.target.value;
                
                const establecimientoSeleccionado = ESTABLECIMIENTOS_DATA.find(e => String(e.ID_Establecimiento) === selectedId);
                
                if (establecimientoSeleccionado) {
                    CLIENTE_CARPETA_ID = establecimientoSeleccionado.ID_Carpeta_Drive; 
                } else {
                    CLIENTE_CARPETA_ID = null;
                }
            };
            
        } else {
            selector.innerHTML = '<option value="" disabled selected>No se encontraron establecimientos para este cliente.</option>';
        }
    }


ย ย async function cargarActividades() {
ย ย ย ย const container = document.getElementById('actividadesContainer');
ย ย ย ย container.innerHTML = '<p>Cargando actividades...</p>';
ย ย ย ยย
ย ย ย ย const result = await fetchData('getActividades');

ย ย ย ย container.innerHTML = ''; 

ย ย ย ย if (result.success && result.data && result.data.length > 0) {
ย ย ย ย ย ย result.data.forEach(act => {
ย ย ย ย ย ย ย ย const item = document.createElement('div');
ย ย ย ย ย ย ย ย item.className = 'actividad-item';
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย const checkbox = document.createElement('input');
ย ย ย ย ย ย ย ย checkbox.type = 'checkbox';
ย ย ย ย ย ย ย ย checkbox.id = act.ID_Actividades;
ย ย ย ย ย ย ย ย checkbox.name = 'actividad';
ย ย ย ย ย ย ย ย checkbox.value = act.ID_Actividades;

ย ย ย ย ย ย ย ย const label = document.createElement('label');
ย ย ย ย ย ย ย ย label.htmlFor = act.ID_Actividades;
ย ย ย ย ย ย ย ย label.textContent = act.Descripcion;
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย item.appendChild(checkbox);
ย ย ย ย ย ย ย ย item.appendChild(label);
ย ย ย ย ย ย ย ย container.appendChild(item);
ย ย ย ย ย ย });
ย ย ย ย } else {
ย ย ย ย ย ย container.innerHTML = '<p>No se encontraron actividades.</p>';
ย ย ย ย }
ย ย }

ย ย // --- FUNCIรN DE ENVรO (POST) ---

ย ย async function enviarReporte(e) {
ย ย ย ย e.preventDefault(); 
ย ย ย ย showStatus('Enviando reporte...', false);ย

ย ย ย ย const checkboxes = document.querySelectorAll('#actividadesContainer input[type="checkbox"]:checked');
ย ย ย ย const actividadesSeleccionadas = Array.from(checkboxes).map(cb => cb.value);

ย ย ย ย const datosDelReporte = {
ย ย ย ย ย ย "Fecha de Visita": document.getElementById('fechaVisita').value, 
ย ย ย ย ย ย "ID_Establecimiento": document.getElementById('idEstablecimiento').value, 
ย ย ย ย ย ย "ID_Profesional": document.getElementById('idProfesional').value,
ย ย ย ย ย ย "Otras tareas realizadas": document.getElementById('otrasTareas').value,
ย ย ย ย ย ย "Observaciones y recomendaciones realizadas": document.getElementById('observaciones').value,
ย ย ย ย ย ย "actividades": actividadesSeleccionadas, 
ย ย ย ย ย ย "ID_Carpeta_Drive": CLIENTE_CARPETA_ID 
ย ย ย ย };

        if (!datosDelReporte.ID_Establecimiento) {
             showStatus("โ Por favor, seleccione un Establecimiento vรกlido.", false);
             return;
        }

ย ย ย ย try {
ย ย ย ย ย ย const respuesta = await fetch(WEB_APP_URL, {
ย ย ย ย ย ย ย ย method: 'POST',
ย ย ย ย ย ย ย ย body: JSON.stringify(datosDelReporte)ย
ย ย ย ย ย ย });

ย ย ย ย ย ย if (!respuesta.ok) {
ย ย ย ย ย ย ย ย throw new Error(`Error HTTP: ${respuesta.status}`);
ย ย ย ย ย ย }

ย ย ย ย ย ย const resultado = await respuesta.json();

ย ย ย ย ย ย if (resultado.success) {
ย ย ย ย ย ย ย ย showStatus(`โ Reporte guardado.`, true); 
ย ย ย ย ย ย ย ย form.reset(); 
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย showStatus(`โ Fallo al guardar: ${resultado.message}`, false);
ย ย ย ย ย ย }

ย ย ย ย } catch (error) {
ย ย ย ย ย ย showStatus(`Hubo un error de conexiรณn o procesamiento: ${error.message}`, false);
ย ย ย ย }
ย ย }

ย ย // --- INICIALIZACIรN ---
ย ย document.addEventListener('DOMContentLoaded', () => {
ย ย ย ย // Cargar Clientes (inicia la cascada)
ย ย ย ย cargarClientes(); 
ย ย ย ย cargarActividades();
ย ย ย ยย
ย ย ย ย form.addEventListener('submit', enviarReporte);
ย ย });
</script>

</body>
</html>