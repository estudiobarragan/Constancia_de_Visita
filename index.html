<!DOCTYPE html>
<html lang="es">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Formulario de Reportes de Visita</title>
Â  Â  <style>
Â  Â  Â  Â  /* Estilos CSS bÃ¡sicos para la presentaciÃ³n */
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: Arial, sans-serif;
Â  Â  Â  Â  Â  Â  margin: 20px;
Â  Â  Â  Â  Â  Â  background-color: #f4f4f9;
Â  Â  Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  }
Â  Â  Â  Â  .container {
Â  Â  Â  Â  Â  Â  max-width: 900px;
Â  Â  Â  Â  Â  Â  margin: auto;
Â  Â  Â  Â  Â  Â  background: #fff;
Â  Â  Â  Â  Â  Â  padding: 30px;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â  h1 {
Â  Â  Â  Â  Â  Â  color: #007bff;
Â  Â  Â  Â  Â  Â  border-bottom: 2px solid #007bff;
Â  Â  Â  Â  Â  Â  padding-bottom: 10px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  label {
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â  input[type="text"], input[type="date"], select, textarea {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  margin-top: 5px;
Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }
Â  Â  Â  Â  textarea {
Â  Â  Â  Â  Â  Â  resize: vertical;
Â  Â  Â  Â  }
Â  Â  Â  Â  .actividades-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border: 1px solid #ddd;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .actividad-item {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .actividad-item input[type="checkbox"] {
Â  Â  Â  Â  Â  Â  width: auto;
Â  Â  Â  Â  Â  Â  margin-right: 8px;
Â  Â  Â  Â  }
Â  Â  Â  Â  button {
Â  Â  Â  Â  Â  Â  background-color: #28a745;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 12px 20px;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  button:hover {
Â  Â  Â  Â  Â  Â  background-color: #218838;
Â  Â  Â  Â  }
Â  Â  Â  Â  .status-message {
Â  Â  Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â  .status-success {
Â  Â  Â  Â  Â  Â  background-color: #d4edda;
Â  Â  Â  Â  Â  Â  color: #155724;
Â  Â  Â  Â  }
Â  Â  Â  Â  .status-error {
Â  Â  Â  Â  Â  Â  background-color: #f8d7da;
Â  Â  Â  Â  Â  Â  color: #721c24;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>

<div class="container">
Â  Â  <h1>ğŸ“ Reporte de Visitas</h1>
Â  Â  <form id="reporteForm">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label for="fechaVisita">Fecha de Visita:</label>
Â  Â  Â  Â  Â  Â  <input type="date" id="fechaVisita" required>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label for="idProfesional">ID Profesional:</label>
Â  Â  Â  Â  Â  Â  <input type="text" id="idProfesional" required>
Â  Â  Â  Â  </div>

        <div>
            <label for="idCliente">Cliente:</label>
            <select id="idCliente" required>
                <option value="" disabled selected>Cargando clientes...</option>
            </select>
        </div>

        <div>
            <label for="idEstablecimiento">Establecimiento:</label>
            <select id="idEstablecimiento" required disabled>
                <option value="" disabled selected>Seleccione primero un cliente...</option>
            </select>
        </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <label>Actividades Realizadas:</label>
Â  Â  Â  Â  <div id="actividadesContainer" class="actividades-grid">
Â  Â  Â  Â  Â  Â  <p>Cargando actividades...</p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label for="otrasTareas">Otras tareas realizadas:</label>
Â  Â  Â  Â  Â  Â  <textarea id="otrasTareas" rows="3"></textarea>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label for="observaciones">Observaciones y recomendaciones realizadas:</label>
Â  Â  Â  Â  Â  Â  <textarea id="observaciones" rows="5"></textarea>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <button type="submit">Guardar Reporte</button>

Â  Â  Â  Â  <div id="statusMessage" class="status-message" style="display: none;"></div>
Â  Â  Â  Â Â 
Â  Â  </form>
</div>

<script>
Â  Â  // âš™ï¸ CONFIGURACIÃ“N: REEMPLAZA ESTA URL CON LA TUYA
Â  Â  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw6noiXFiMbctGbB99rW_1dlMsK7-0vMwUDRHUgvhzL3bWipdLz5-YkeluvoznpSGok/exec';Â 
Â  Â  const form = document.getElementById('reporteForm');
Â  Â  const statusMessage = document.getElementById('statusMessage');
Â  Â  let CLIENTE_CARPETA_ID = null;
    let ESTABLECIMIENTOS_DATA = []; // Almacena los datos del establecimiento actual

Â  Â  // --- FUNCIONES DE UTILIDAD ---

Â  Â  /**
Â  Â  Â * Muestra un mensaje de estado en la interfaz.
Â  Â  Â * @param {string} message Mensaje a mostrar.
Â  Â  Â * @param {boolean} isSuccess Si es verdadero, usa estilo de Ã©xito.
Â  Â  Â */
Â  Â  function showStatus(message, isSuccess) {
Â  Â  Â  Â  statusMessage.textContent = message;
Â  Â  Â  Â  statusMessage.style.display = 'block';
Â  Â  Â  Â  statusMessage.className = 'status-message ' + (isSuccess ? 'status-success' : 'status-error');
Â  Â  }

Â  Â  /**
Â  Â  Â * Realiza una peticiÃ³n GET a la App Script.
Â  Â  Â * @param {string} actionUrl La URL completa con parÃ¡metros 'action' y 'ID_Cliente'.
Â  Â  Â * @returns {Promise<Object>} El objeto de respuesta JSON.
Â  Â  Â */
Â  Â  async function fetchData(actionUrl) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const url = `${WEB_APP_URL}?action=${actionUrl}`;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  console.log(`[CLIENTE] Llamando a: ${url}`); // Registro de la URL que se usa

Â  Â  Â  Â  Â  Â  const response = await fetch(url);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  console.log(`[CLIENTE] Respuesta HTTP recibida: ${response.status} - OK: ${response.ok}`);

Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  // Si el error no es 200, lanzamos la excepciÃ³n
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`HTTP error! status: ${response.status}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Convertir la respuesta a JSON
Â  Â  Â  Â  Â  Â  const data = await response.json();Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  console.log(`[CLIENTE] Datos recibidos de ${actionUrl}:`, data);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  return data;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error(`[CLIENTE] Error en fetchData para acciÃ³n ${actionUrl}:`, error);
Â  Â  Â  Â  Â  Â  return { success: false, message: 'Error de red o servidor: ' + error.message };
Â  Â  Â  Â  }
Â  Â  }

    // --- FUNCIONES DE CARGA (GET) ---
    
    /**
     * Nueva funciÃ³n: Carga la lista de clientes en el selector 'idCliente'.
     */
    async function cargarClientes() {
        const selector = document.getElementById('idCliente');
        selector.innerHTML = '<option value="" disabled selected>Cargando clientes...</option>'; 

        const result = await fetchData('getClientes'); 
        selector.innerHTML = ''; 
        
        if (result.success && result.data && result.data.length > 0) {
            selector.appendChild(new Option('Seleccione un cliente...', '', '', true));
            
            result.data.forEach(cliente => {
                // Guardamos el ID_Cliente como value y el Nombre de la Empresa como texto
                const option = new Option(cliente.Nombre_Empresa, cliente.ID_Cliente);
                selector.appendChild(option);
            });

            // CLAVE: Escuchador de Eventos para el cambio de cliente
            selector.addEventListener('change', (event) => {
                const selectedId = event.target.value;
                // Al seleccionar un cliente, se cargan los establecimientos.
                cargarEstablecimientos(selectedId); 
            });
            
        } else {
            selector.innerHTML = '<option value="" disabled selected>No se encontraron clientes.</option>';
        }
    }

    /**
     * Modificada: Carga la lista de establecimientos, ahora filtrada por ID_Cliente.
     */
    async function cargarEstablecimientos(ID_Cliente_Filtro = null) {
        const selector = document.getElementById('idEstablecimiento');
        // Limpiamos y deshabilitamos mientras cargamos o si no hay filtro
        selector.innerHTML = ''; 
        selector.disabled = true;

        if (!ID_Cliente_Filtro) {
            selector.innerHTML = '<option value="" disabled selected>Seleccione primero un cliente...</option>';
            return;
        }

        selector.innerHTML = '<option value="" disabled selected>Cargando establecimientos...</option>';
        
        // Creamos la URL de acciÃ³n con el filtro
        const actionUrl = `getEstablecimientos&ID_Cliente=${ID_Cliente_Filtro}`;

        const result = await fetchData(actionUrl); 

        selector.innerHTML = ''; // Limpiar antes de rellenar

        if (result.success && result.data && result.data.length > 0) {
            
            ESTABLECIMIENTOS_DATA = result.data; // Guardamos los datos para usar el ID de carpeta despuÃ©s
            
            selector.appendChild(new Option('Seleccione un establecimiento...', '', '', true));
            
            // Rellenar el selector
            ESTABLECIMIENTOS_DATA.forEach(est => {
                const option = new Option(`${est.Denominacion} (${est.Direccion})`, est.ID_Establecimiento);
                selector.appendChild(option);
            });
            
            // Habilitar el dropdown de Establecimientos
            selector.disabled = false;

            // Aseguramos que el listener de 'change' estÃ© en el selector de Establecimiento
            // Nota: Se debe remover el listener anterior antes de aÃ±adir uno nuevo si se llama varias veces,
            // pero para esta prueba simple, lo sobreescribimos.

            selector.onchange = (event) => {
                const selectedId = event.target.value;
                
                // Buscar el objeto completo (que incluye ID_Carpeta_Drive)
                const establecimientoSeleccionado = ESTABLECIMIENTOS_DATA.find(e => String(e.ID_Establecimiento) === selectedId);
                
                if (establecimientoSeleccionado) {
                    // GUARDAR EL ID DE CARPETA en la variable global
                    CLIENTE_CARPETA_ID = establecimientoSeleccionado.ID_Carpeta_Drive; 
                } else {
                    CLIENTE_CARPETA_ID = null;
                }
                
                console.log("ID de Carpeta Guardado:", CLIENTE_CARPETA_ID); // Para depurar
            };
            
        } else {
            selector.innerHTML = '<option value="" disabled selected>No se encontraron establecimientos para este cliente.</option>';
        }
    }


Â  Â  async function cargarActividades() {
Â  Â  Â  Â  const container = document.getElementById('actividadesContainer');
Â  Â  Â  Â  container.innerHTML = '<p>Cargando actividades...</p>';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const result = await fetchData('getActividades');

Â  Â  Â  Â  container.innerHTML = ''; // Limpiar despuÃ©s de la carga

Â  Â  Â  Â  if (result.success && result.data && result.data.length > 0) {
Â  Â  Â  Â  Â  Â  result.data.forEach(act => {
Â  Â  Â  Â  Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  item.className = 'actividad-item';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const checkbox = document.createElement('input');
Â  Â  Â  Â  Â  Â  Â  Â  checkbox.type = 'checkbox';
Â  Â  Â  Â  Â  Â  Â  Â  checkbox.id = act.ID_Actividades;
Â  Â  Â  Â  Â  Â  Â  Â  checkbox.name = 'actividad';
Â  Â  Â  Â  Â  Â  Â  Â  checkbox.value = act.ID_Actividades;

Â  Â  Â  Â  Â  Â  Â  Â  const label = document.createElement('label');
Â  Â  Â  Â  Â  Â  Â  Â  label.htmlFor = act.ID_Actividades;
Â  Â  Â  Â  Â  Â  Â  Â  label.textContent = act.Descripcion;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  item.appendChild(checkbox);
Â  Â  Â  Â  Â  Â  Â  Â  item.appendChild(label);
Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(item);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  container.innerHTML = '<p>No se encontraron actividades.</p>';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- FUNCIÃ“N DE ENVÃO (POST) ---

Â  Â  async function enviarReporte(e) {
Â  Â  Â  Â  e.preventDefault(); // Evita el envÃ­o tradicional del formulario
Â  Â  Â  Â  showStatus('Enviando reporte...', false);Â 

Â  Â  Â  Â  // 1. RecolecciÃ³n de Checkboxes
Â  Â  Â  Â  const checkboxes = document.querySelectorAll('#actividadesContainer input[type="checkbox"]:checked');
Â  Â  Â  Â  const actividadesSeleccionadas = Array.from(checkboxes).map(cb => cb.value);

Â  Â  Â  Â  // 2. ConstrucciÃ³n del JSON
Â  Â  Â  Â  const datosDelReporte = {
Â  Â  Â  Â  Â  Â  // NOTA: El campo "Fecha de Visita" usa la clave del backend, no la del ID HTML.
Â  Â  Â  Â  Â  Â  "Fecha de Visita": document.getElementById('fechaVisita').value, 
Â  Â  Â  Â  Â  Â  "ID_Establecimiento": document.getElementById('idEstablecimiento').value, // El valor es el ID del Establecimiento
Â  Â  Â  Â  Â  Â  "ID_Profesional": document.getElementById('idProfesional').value,
Â  Â  Â  Â  Â  Â  "Otras tareas realizadas": document.getElementById('otrasTareas').value,
Â  Â  Â  Â  Â  Â  "Observaciones y recomendaciones realizadas": document.getElementById('observaciones').value,
Â  Â  Â  Â  Â  Â  "actividades": actividadesSeleccionadas, // Array de IDs de las actividades marcadas
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // ğŸ›‘ El backend usa su propia bÃºsqueda, pero lo mandamos por consistencia
Â  Â  Â  Â  Â  Â  "ID_Carpeta_Drive": CLIENTE_CARPETA_ID 
Â  Â  Â  Â  };

        if (!datosDelReporte.ID_Establecimiento) {
             showStatus("âŒ Por favor, seleccione un Establecimiento vÃ¡lido.", false);
             return;
        }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // 3. PeticiÃ³n POST
Â  Â  Â  Â  Â  Â  const respuesta = await fetch(WEB_APP_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(datosDelReporte)Â 
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (!respuesta.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Error HTTP: ${respuesta.status}`);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const resultado = await respuesta.json();

Â  Â  Â  Â  Â  Â  // 4. Manejar el resultado
Â  Â  Â  Â  Â  Â  if (resultado.success) {
Â  Â  Â  Â  Â  Â  Â  Â  // NOTA: El ID_Reporte se genera en el backend, revisa si tu doPost lo devuelve.
Â  Â  Â  Â  Â  Â  Â  Â  showStatus(`âœ… Reporte guardado.`, true); 
Â  Â  Â  Â  Â  Â  Â  Â  form.reset(); // Limpiar el formulario
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  showStatus(`âŒ Fallo al guardar: ${resultado.message}`, false);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  showStatus(`Hubo un error de conexiÃ³n o procesamiento: ${error.message}`, false);
Â  Â  Â  Â  Â  Â  console.error("Error al enviar el reporte:", error);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- INICIALIZACIÃ“N ---
Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  // 1. Ejecutar las llamadas GET al cargar la pÃ¡gina: Cargar Clientes primero.
Â  Â  Â  Â  cargarClientes(); 
Â  Â  Â  Â  cargarActividades();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 2. Asignar la funciÃ³n de envÃ­o al evento submit del formulario
Â  Â  Â  Â  form.addEventListener('submit', enviarReporte);
Â  Â  });
</script>

</body>
</html>