<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Reportes de Visita</title>
    <style>
        /* Estilos CSS b√°sicos para la presentaci√≥n */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
        }
        input[type="text"], input[type="date"], select, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
        }
        .actividades-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .actividad-item {
            display: flex;
            align-items: center;
        }
        .actividad-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }
        button {
            background-color: #28a745;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }
        button:hover {
            background-color: #218838;
        }
        .status-message {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üìù Reporte de Visitas</h1>
    <form id="reporteForm">
        
        <div>
            <label for="fechaVisita">Fecha de Visita:</label>
            <input type="date" id="fechaVisita" required>
        </div>

        <div>
            <label for="idProfesional">ID Profesional:</label>
            <input type="text" id="idProfesional" required>
        </div>

        <div>
            <label for="idEstablecimiento">Establecimiento:</label>
            <select id="idEstablecimiento" required>
                <option value="" disabled selected>Cargando establecimientos...</option>
            </select>
        </div>
        
        <label>Actividades Realizadas:</label>
        <div id="actividadesContainer" class="actividades-grid">
            <p>Cargando actividades...</p>
        </div>

        <div>
            <label for="otrasTareas">Otras tareas realizadas:</label>
            <textarea id="otrasTareas" rows="3"></textarea>
        </div>

        <div>
            <label for="observaciones">Observaciones y recomendaciones realizadas:</label>
            <textarea id="observaciones" rows="5"></textarea>
        </div>

        <button type="submit">Guardar Reporte</button>

        <div id="statusMessage" class="status-message" style="display: none;"></div>
        
    </form>
</div>

<script>
    // ‚öôÔ∏è CONFIGURACI√ìN: REEMPLAZA ESTA URL CON LA TUYA
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw6noiXFiMbctGbB99rW_1dlMsK7-0vMwUDRHUgvhzL3bWipdLz5-YkeluvoznpSGok/exec'; 
    const form = document.getElementById('reporteForm');
    const statusMessage = document.getElementById('statusMessage');
    let CLIENTE_CARPETA_ID = null;

    // --- FUNCIONES DE UTILIDAD ---

    /**
     * Muestra un mensaje de estado en la interfaz.
     * @param {string} message Mensaje a mostrar.
     * @param {boolean} isSuccess Si es verdadero, usa estilo de √©xito.
     */
    function showStatus(message, isSuccess) {
        statusMessage.textContent = message;
        statusMessage.style.display = 'block';
        statusMessage.className = 'status-message ' + (isSuccess ? 'status-success' : 'status-error');
    }

    /**
     * Realiza una petici√≥n GET a la App Script.
     * @param {string} action El par√°metro 'action' para el endpoint.
     * @returns {Promise<Object>} El objeto de respuesta JSON.
     */
    async function fetchData(action) {
        const url = `${WEB_APP_URL}?action=${action}`;
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Error de red: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error(`Error al obtener ${action}:`, error);
            showStatus(`Error al cargar datos (${action}). Verifique la URL y el despliegue.`, false);
            throw error; // Propagar el error para detener el flujo de carga
        }
    }

    // --- FUNCIONES DE CARGA (GET) ---

    async function cargarEstablecimientos() {
        // 1. Obtener el selector del HTML
        const selector = document.getElementById('idEstablecimiento');
        
        selector.innerHTML = '<option value="" disabled selected>Cargando ...</option>'; 

        // 2. Obtener los datos del Apps Script (incluye el ID_Carpeta_Drive gracias a la modificaci√≥n en Code.gs)
        const result = await fetchData('getEstablecimientos'); 

        selector.innerHTML = ''; // Limpiar despu√©s de la carga

        if (result.success && result.data && result.data.length > 0) {
            
            // 3. Almacenar los datos de los clientes para el evento 'change'
            const establecimientos = result.data; 
            
            // A√±adir opci√≥n por defecto
            selector.appendChild(new Option('Seleccione un establecimiento...', '', '', true));
            
            // Rellenar el selector con los datos
            establecimientos.forEach(est => {
                // Se usa est.ID_Establecimiento como value, y el texto combinado como label
                const option = new Option(`${est.Denominacion} (${est.Direccion})`, est.ID_Establecimiento);
                selector.appendChild(option);
            });

            // 4. Agregar el Escuchador de Eventos (CLAVE: Aqu√≠ se guarda el ID de Carpeta)
            selector.addEventListener('change', (event) => {
                const selectedId = event.target.value;
                
                // Buscar el objeto completo que incluye ID_Carpeta_Drive
                const clienteSeleccionado = establecimientos.find(e => e.ID_Establecimiento === selectedId);
                
                if (clienteSeleccionado) {
                    // GUARDAR EL ID DE CARPETA en la variable global
                    CLIENTE_CARPETA_ID = clienteSeleccionado.ID_Carpeta_Drive; 
                    
                    // Opcional: Mostrar Denominaci√≥n y Direcci√≥n
                    // Si tienes campos con estos IDs en tu HTML, se actualizar√°n aqu√≠.
                    // document.getElementById('denominacion_mostrar').value = clienteSeleccionado.Denominacion;
                    // document.getElementById('direccion_mostrar').value = clienteSeleccionado.Direccion;
                } else {
                    CLIENTE_CARPETA_ID = null;
                }
                // Puedes descomentar para depurar: console.log("ID de Carpeta Guardado:", CLIENTE_CARPETA_ID); 
            });
            
        } else {
            selector.innerHTML = '<option value="" disabled selected>No se encontraron establecimientos.</option>';
            console.error("Error al cargar datos (getEstablecimientos). Verifique la URL y el despliegue.");
        }
    }

    async function cargarActividades() {
        const container = document.getElementById('actividadesContainer');
        container.innerHTML = '<p>Cargando actividades...</p>';
        
        const result = await fetchData('getActividades');

        container.innerHTML = ''; // Limpiar despu√©s de la carga

        if (result.success && result.data && result.data.length > 0) {
            result.data.forEach(act => {
                const item = document.createElement('div');
                item.className = 'actividad-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = act.ID_Actividades;
                checkbox.name = 'actividad';
                checkbox.value = act.ID_Actividades;

                const label = document.createElement('label');
                label.htmlFor = act.ID_Actividades;
                label.textContent = act.Descripcion;
                
                item.appendChild(checkbox);
                item.appendChild(label);
                container.appendChild(item);
            });
        } else {
            container.innerHTML = '<p>No se encontraron actividades.</p>';
        }
    }

    // --- FUNCI√ìN DE ENV√çO (POST) ---

    async function enviarReporte(e) {
        e.preventDefault(); // Evita el env√≠o tradicional del formulario
        showStatus('Enviando reporte...', false); 

        // 1. Recolecci√≥n de Checkboxes
        const checkboxes = document.querySelectorAll('#actividadesContainer input[type="checkbox"]:checked');
        const actividadesSeleccionadas = Array.from(checkboxes).map(cb => cb.value);

        // 2. Construcci√≥n del JSON
        const datosDelReporte = {
            "Fecha de Visita": document.getElementById('fechaVisita').value,
            "ID_Establecimiento": parseInt(document.getElementById('idEstablecimiento').value), // Asegurar que sea n√∫mero
            "ID_Profesional": document.getElementById('idProfesional').value,
            "Otras tareas realizadas": document.getElementById('otrasTareas').value,
            "Observaciones y recomendaciones realizadas": document.getElementById('observaciones').value,
            "actividades": actividadesSeleccionadas // Array de IDs de las actividades marcadas
        };

        "ID_Carpeta_Drive": CLIENTE_CARPETA_ID

        try {
            // 3. Petici√≥n POST
            const respuesta = await fetch(WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify(datosDelReporte) 
            });

            if (!respuesta.ok) {
                throw new Error(`Error HTTP: ${respuesta.status}`);
            }

            const resultado = await respuesta.json();

            // 4. Manejar el resultado
            if (resultado.success) {
                showStatus(`‚úÖ Reporte guardado. Nuevo ID: ${resultado.ID_Reporte}`, true);
                form.reset(); // Limpiar el formulario
                // Recargar listas si es necesario, pero no es crucial aqu√≠
            } else {
                showStatus(`‚ùå Fallo al guardar: ${resultado.message}`, false);
            }

        } catch (error) {
            showStatus(`Hubo un error de conexi√≥n o procesamiento: ${error.message}`, false);
            console.error("Error al enviar el reporte:", error);
        }
    }

    // --- INICIALIZACI√ìN ---
    document.addEventListener('DOMContentLoaded', () => {
        // Ejecutar las llamadas GET al cargar la p√°gina
        cargarEstablecimientos();
        cargarActividades();
        
        // Asignar la funci√≥n de env√≠o al evento submit del formulario
        form.addEventListener('submit', enviarReporte);
    });
</script>

</body>
</html>